<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/layout}">
<head>
    <meta charset="UTF-8">
    <title th:text="${categoryName}">ì¹´í…Œê³ ë¦¬ í´ë˜ìŠ¤</title>
    <style>
        .card.h-100 {
            position: relative;
            border: none;
            transition: all 0.2s ease-in-out;
            border-radius: 5px;
            width: 100%;
            height: 300px;
        }

        .card-img-top {
            object-fit: cover;
            border-radius: 5px;
            height: 150px;
        }

        .card-body {
            padding: 10px 0;
        }

        .card-title {
            font-size: 0.95rem;
            font-weight: bold;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .card-subtitle {
            font-size: 0.85rem;
            color: #666;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .card-bookmark {
            position: absolute;
            top: 8px;
            right: 10px;
            font-size: 1rem;
            color: #fff;
            z-index: 2;
            padding: 5px;
            border-radius: 5px;
            background-color: rgba(0, 0, 0, 0.5);
        }

        #classListContainer .col {
            display: flex;
        }

        #classListContainer .card {
            flex: 1;
            min-width: 0;
        }

        /* activeëœ í˜ì´ì§€ ë²„íŠ¼ */
        .pagination .page-item.active .page-link {
            background-color: #fe5d01;
            border-color: #fe5d01;
            color: white;
        }

        /* ì¼ë°˜ í˜ì´ì§€ ë²„íŠ¼ */
        .pagination .page-link {
            background-color: white;
            border: 1px solid #fe5d01;
            color: #fe5d01;
        }

        /* hover ì‹œ */
        .pagination .page-link:hover {
            background-color: #fe5d01;
            color: white;
            border-color: #fe5d01;
        }

        .text-ellipsis {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

    </style>
</head>
<body>
<div id="container" class="mt-3  mb-3" layout:fragment="content">
    <div class="">
        <div class="row">
            <!-- ì™¼ìª½ ì‚¬ì´ë“œ ì¹´í…Œê³ ë¦¬ -->
            <aside class="col-md-2">
                <h3 class="fw-bold mb-3">[[${categoryName}]]</h3>
                <!--                <ul class="list-unstyled">-->
                <!--                    <li>-->
                <!--                        <a th:href="@{/classes(categoryIdx=${categoryIdx})}"-->
                <!--                           th:classappend="${#strings.isEmpty(sub)} ? 'fw-bold text-orange' : ''">-->
                <!--                            ì „ì²´-->
                <!--                        </a>-->
                <!--                    </li>-->
                <!--                    <li>-->
                <!--                        <a th:href="@{/classes(categoryIdx=${categoryIdx}, sub='ì£¼ì‹')}"-->
                <!--                           th:classappend="${sub == 'ì£¼ì‹'} ? 'fw-bold text-orange' : ''">-->
                <!--                            ì£¼ì‹-->
                <!--                        </a>-->
                <!--                    </li>-->
                <!--                    <li>-->
                <!--                        <a th:href="@{/classes(categoryIdx=${categoryIdx}, sub='ë¶€ë™ì‚°')}"-->
                <!--                           th:classappend="${sub == 'ë¶€ë™ì‚°'} ? 'fw-bold text-orange' : ''">-->
                <!--                            ë¶€ë™ì‚°-->
                <!--                        </a>-->
                <!--                    </li>-->
                <!--                    <li>-->
                <!--                        <a href="#">ë” ìƒˆë¡œìš´ [[${categoryName}]]</a>-->
                <!--                    </li>-->
                <!--                </ul>-->
            </aside>

            <!-- ì˜¤ë¥¸ìª½ ë³¸ë¬¸ -->
            <main class="col-md-10">
                <!-- í¬ë¦¬ì—ì´í„° ëª©ë¡ -->
                <div id="creatorSectionContainer" class="justify-content-center mb-4" style="gap: 1rem;"></div>

                <!-- í•„í„° ì˜ì—­ -->
                <div class="d-flex justify-content-end mb-4 gap-2">
                    <select id="sortOption" class="form-select form-select-sm" style="width: 100px;">
                        <option value="popular">ì¸ê¸°ìˆœ</option>
                        <option value="recent" selected>ìµœì‹ ìˆœ</option>
                        <option value="old">ì˜¤ë˜ëœìˆœ</option>
                    </select>
                    <select id="pageSizeOption" class="form-select form-select-sm" style="width: 120px;">
                        <option value="1">1ê°œì”© ë³´ê¸°</option>
                        <option value="10">10ê°œì”© ë³´ê¸°</option>
                        <option value="12" selected>12ê°œì”© ë³´ê¸°</option>
                        <option value="100">100ê°œì”© ë³´ê¸°</option>
                    </select>
                </div>

                <!-- í´ë˜ìŠ¤ ëª©ë¡ -->
                <div id="classListContainer" class="row row-cols-1 row-cols-md-3 row-cols-lg-4 g-3"></div>
                <nav class="mt-4 d-flex justify-content-center">
                    <ul id="pagination" class="pagination pagination-sm"></ul>
                </nav>

                <script th:inline="javascript">
                    let latestCreators = [];
                    let currentCreatorMode = window.innerWidth >= 992 ? 'carousel' : 'scroll';

                    window.addEventListener("resize", () => {
                        const newMode = window.innerWidth >= 992 ? 'carousel' : 'scroll';
                        if (newMode !== currentCreatorMode) {
                            currentCreatorMode = newMode;
                            renderCreators(latestCreators);
                        }
                    });

                    function loadCreators(categoryIdx) {
                        fetch(`/api/classes/creators/category/${categoryIdx}`)
                            .then(res => res.json())
                            .then(creators => {
                                console.log("ğŸ¨ í¬ë¦¬ì—ì´í„° ëª©ë¡", creators);
                                latestCreators = creators;
                                renderCreators(creators);
                            })
                            .catch(err => console.error("í¬ë¦¬ì—ì´í„° ë¡œë“œ ì‹¤íŒ¨", err));
                    }

                    function renderCreators(creators) {
                        if (!creators || !creators.length) return;

                        const sectionId = `creator-carousel`;
                        const isWideScreen = window.innerWidth >= 992;

                        if (isWideScreen) {
                            const slides = [];
                            for (let i = 0; i < creators.length; i += 5) {
                                const group = creators.slice(i, i + 5);
                                while (group.length < 5) group.push(null);
                                slides.push(group);
                            }

                            const slideItemsHtml = slides.map((group, idx) => `
            <div class="carousel-item ${idx === 0 ? 'active' : ''}">
                <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-5 g-3">
                    ${group.map(creator => {
                                if (!creator) return `<div class="col"></div>`;
                                return `
                            <div class="col">
                                <div class="creator-card border rounded text-center p-3 h-100" style="background-color: white;">
                                    <img src="${creator.profileImage}" alt="í”„ë¡œí•„"
                                         class="rounded-circle mb-2"
                                         style="width: 60px; height: 60px; object-fit: cover; border: 2px solid white;">
                                    <p class="fw-bold small mb-1">${creator.name}</p>
                                    <p class="text-muted small mb-0 text-truncate">${creator.description}</p>
                                </div>
                            </div>
                        `;
                            }).join('')}
                </div>
            </div>
        `).join('');

                            document.getElementById("creatorSectionContainer").innerHTML = `
            <section class="mb-5">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h5 class="fw-bold mb-0">í¬ë¦¬ì—ì´í„°</h5>
                    <div>
                        <button class="btn btn-sm me-2" type="button" data-bs-target="#${sectionId}" data-bs-slide="prev">
                            <i class="bi bi-chevron-left fs-5 text-dark"></i>
                        </button>
                        <button class="btn btn-sm" type="button" data-bs-target="#${sectionId}" data-bs-slide="next">
                            <i class="bi bi-chevron-right fs-5 text-dark"></i>
                        </button>
                    </div>
                </div>
                <div id="${sectionId}" class="carousel slide" data-bs-ride="false">
                    <div class="carousel-inner">
                        ${slideItemsHtml}
                    </div>
                </div>
            </section>
        `;
                        }
                    }

                    const categoryIdx = /*[[${categoryIdx}]]*/ 0;
                    let pageSize = parseInt(document.getElementById("pageSizeOption").value);
                    let currentPage = 0;
                    let currentSort = 'recent';

                    // í´ë˜ìŠ¤ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
                    function loadClasses(page) {
                        currentPage = page;

                        fetch(`/api/classes/category/${categoryIdx}?page=${page}&size=${pageSize}&sort=${currentSort}`)
                            .then(res => res.json())
                            .then(data => {
                                renderClassList(data.content);
                                renderPagination(data.totalPages, data.number);
                            })
                            .catch(err => console.error("í´ë˜ìŠ¤ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨", err));
                    }

                    document.getElementById("pageSizeOption").addEventListener("change", (e) => {
                        pageSize = parseInt(e.target.value);
                        loadCreators(categoryIdx);
                        loadClasses(0); // ì²« í˜ì´ì§€ë¡œ ì´ë™
                    });

                    document.getElementById("sortOption").addEventListener("change", (e) => {
                        currentSort = e.target.value;
                        loadClasses(0); // ì²« í˜ì´ì§€ë¡œ ì´ë™
                    });


                    // í´ë˜ìŠ¤ ëª©ë¡ ë Œë”ë§
                    function renderClassList(classList) {
                        const container = document.getElementById("classListContainer");
                        container.innerHTML = "";

                        if (!classList.length) {
                            container.innerHTML = "<p class='text-muted'>ë“±ë¡ëœ í´ë˜ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤.</p>";
                            return;
                        }

                        classList.forEach(cls => {
                            const col = document.createElement("div");
                            col.className = "col d-flex";

                            const card = document.createElement("div");
                            card.className = "card h-100 position-relative";
                            card.style.width = "100%";
                            card.addEventListener("click", () => {
                                window.location.href = `/class/${cls.classIdx}`;
                            });

                            const img = document.createElement("img");
                            img.src = cls.thumbnailUrl || "/images/default-image.png";
                            img.className = "card-img-top";
                            img.alt = "ì¸ë„¤ì¼";
                            img.onerror = function () {
                                this.onerror = null;
                                this.src = "/images/default-image.png";
                            };

                            const bookmark = document.createElement("div");
                            bookmark.className = "card-bookmark" + (cls.liked ? " active" : "");
                            bookmark.innerHTML = `<i class="bi ${cls.liked ? "bi-bookmark-fill" : "bi-bookmark"}"></i>`;
                            bookmark.style.cursor = "pointer";
                            bookmark.addEventListener("click", () => toggleBookmark(bookmark, cls.classIdx));

                            const body = document.createElement("div");
                            body.className = "card-body";

                            const title = document.createElement("p");
                            title.className = "card-title";
                            title.textContent = cls.classTitle;

                            const subtitle = document.createElement("p");
                            subtitle.className = "card-subtitle";
                            subtitle.textContent = `${cls.categoryName} â”‚ ${cls.creatorName || ""}`;

                            body.appendChild(title);
                            body.appendChild(subtitle);

                            card.appendChild(img);
                            card.appendChild(bookmark);
                            card.appendChild(body);
                            col.appendChild(card);
                            container.appendChild(col);
                        });
                    }

                    // í˜ì´ì§€ë„¤ì´ì…˜ ë Œë”ë§
                    function renderPagination(totalPages, currentPage) {
                        const pagination = document.getElementById("pagination");
                        pagination.innerHTML = "";

                        const groupSize = 10;
                        const currentGroup = Math.floor(currentPage / groupSize);
                        const startPage = currentGroup * groupSize;
                        const endPage = Math.min(startPage + groupSize, totalPages);

                        // <<
                        if (currentPage > 0) appendPageItem("<<", 0);

                        // <
                        if (startPage > 0) appendPageItem("<", startPage - 1);

                        // í˜ì´ì§€ ìˆ«ì
                        for (let i = startPage; i < endPage; i++) {
                            appendPageItem(i + 1, i, i === currentPage);
                        }

                        // >
                        if (endPage < totalPages) appendPageItem(">", endPage);

                        // >>
                        if (currentPage < totalPages - 1) appendPageItem(">>", totalPages - 1);

                        function appendPageItem(label, pageIndex, isActive = false) {
                            const li = document.createElement("li");
                            li.className = `page-item ${isActive ? "active" : ""}`;

                            const btn = document.createElement("button");
                            btn.className = "page-link";
                            btn.textContent = label;
                            btn.addEventListener("click", () => {
                                if (pageIndex !== currentPage) {
                                    loadClasses(pageIndex);
                                }
                            });

                            li.appendChild(btn);
                            pagination.appendChild(li);
                        }
                    }

                    // ì´ˆê¸° ë¡œë”©
                    window.addEventListener("DOMContentLoaded", () => {
                        loadCreators(categoryIdx);
                        loadClasses(0);
                    });

                    // ì°œ í† ê¸€ ê¸°ëŠ¥
                    const toggleBookmark = async (bookmarkEl, classId) => {
                        try {
                            const res = await fetch(`/api/class-like/${classId}`, {
                                method: "POST",
                                credentials: "same-origin"
                            });

                            if (res.status === 401) {
                                alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
                                return;
                            }

                            const result = await res.json();
                            const icon = bookmarkEl.querySelector("i");

                            if (result.liked) {
                                bookmarkEl.classList.add("active");
                                icon.classList.remove("bi-bookmark");
                                icon.classList.add("bi-bookmark-fill");
                            } else {
                                bookmarkEl.classList.remove("active");
                                icon.classList.remove("bi-bookmark-fill");
                                icon.classList.add("bi-bookmark");
                            }
                        } catch (err) {
                            console.error("ì°œ ìƒíƒœ ë³€ê²½ ì‹¤íŒ¨:", err);
                        }
                    };
                </script>

            </main>
        </div>
    </div>
    <!-- í•˜ë‹¨ ê³ ì • CTA ë°” -->
    <div class="position-fixed bottom-0 start-0 end-0 bg-white border-top py-3 px-4 d-flex justify-content-between align-items-center"
         style="z-index: 1050;">
        <div class="fw-bold">ë“£ê³  ì‹¶ì€ í´ë˜ìŠ¤ë¥¼ ë‹¤ ë“¤ì–´ë³´ì„¸ìš”<br><a href="#" class="text-decoration-underline text-dark">êµ¬ë… ë” ì•Œì•„ë³´ê¸°</a>
        </div>
        <button class="btn btn-warning fw-bold px-4 py-2"
                style="width: 300px; background-color: #FE5D01; color: white;">ë°”ë¡œ ì‹œì‘í•˜ê¸°
        </button>
    </div>
</div>
</body>
</html>
