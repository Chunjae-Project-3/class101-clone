<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/layout}">
<head>
    <meta charset="UTF-8">
    <title th:text="${categoryName}">카테고리 클래스</title>
    <style>
        .card.h-100 {
            position: relative;
            border: none;
            transition: all 0.2s ease-in-out;
            border-radius: 5px;
            width: 100%;
            height: 300px;
        }

        .card-img-top {
            object-fit: cover;
            border-radius: 5px;
            height: 150px;
        }

        .card-body {
            padding: 10px 0;
        }

        .card-title {
            font-size: 0.95rem;
            font-weight: bold;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .card-subtitle {
            font-size: 0.85rem;
            color: #666;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .card-bookmark {
            position: absolute;
            top: 8px;
            right: 10px;
            font-size: 1rem;
            color: #fff;
            z-index: 2;
            padding: 5px;
            border-radius: 5px;
            background-color: rgba(0, 0, 0, 0.5);
        }

        #classListContainer .col {
            display: flex;
        }

        #classListContainer .card {
            flex: 1;
            min-width: 0;
        }

        /* active된 페이지 버튼 */
        .pagination .page-item.active .page-link {
            background-color: #fe5d01;
            border-color: #fe5d01;
            color: white;
        }

        /* 일반 페이지 버튼 */
        .pagination .page-link {
            background-color: white;
            border: 1px solid #fe5d01;
            color: #fe5d01;
        }

        /* hover 시 */
        .pagination .page-link:hover {
            background-color: #fe5d01;
            color: white;
            border-color: #fe5d01;
        }

        .text-ellipsis {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

    </style>
</head>
<body>
<div id="container" class="mt-3  mb-3" layout:fragment="content">
    <div class="">
        <div class="row">
            <!-- 왼쪽 사이드 카테고리 -->
            <aside class="col-md-2">
                <h3 class="fw-bold mb-3">[[${categoryName}]]</h3>
                <!--                <ul class="list-unstyled">-->
                <!--                    <li>-->
                <!--                        <a th:href="@{/classes(categoryIdx=${categoryIdx})}"-->
                <!--                           th:classappend="${#strings.isEmpty(sub)} ? 'fw-bold text-orange' : ''">-->
                <!--                            전체-->
                <!--                        </a>-->
                <!--                    </li>-->
                <!--                    <li>-->
                <!--                        <a th:href="@{/classes(categoryIdx=${categoryIdx}, sub='주식')}"-->
                <!--                           th:classappend="${sub == '주식'} ? 'fw-bold text-orange' : ''">-->
                <!--                            주식-->
                <!--                        </a>-->
                <!--                    </li>-->
                <!--                    <li>-->
                <!--                        <a th:href="@{/classes(categoryIdx=${categoryIdx}, sub='부동산')}"-->
                <!--                           th:classappend="${sub == '부동산'} ? 'fw-bold text-orange' : ''">-->
                <!--                            부동산-->
                <!--                        </a>-->
                <!--                    </li>-->
                <!--                    <li>-->
                <!--                        <a href="#">더 새로운 [[${categoryName}]]</a>-->
                <!--                    </li>-->
                <!--                </ul>-->
            </aside>

            <!-- 오른쪽 본문 -->
            <main class="col-md-10">
                <!-- 크리에이터 목록 -->
                <div id="creatorSectionContainer" class="justify-content-center mb-4" style="gap: 1rem;"></div>

                <!-- 필터 영역 -->
                <div class="d-flex justify-content-end mb-4 gap-2">
                    <select id="sortOption" class="form-select form-select-sm" style="width: 100px;">
                        <option>인기순</option>
                        <option>최신순</option>
                    </select>
                    <select id="pageSizeOption" class="form-select form-select-sm" style="width: 120px;">
                        <option value="1">1개씩 보기</option>
                        <option value="10">10개씩 보기</option>
                        <option value="12" selected>12개씩 보기</option>
                        <option value="100">100개씩 보기</option>
                    </select>
                </div>

                <!-- 클래스 목록 -->
                <div id="classListContainer" class="row row-cols-1 row-cols-md-3 row-cols-lg-4 g-3"></div>
                <nav class="mt-4 d-flex justify-content-center">
                    <ul id="pagination" class="pagination pagination-sm"></ul>
                </nav>

                <script th:inline="javascript">
                    let latestCreators = [];
                    let currentCreatorMode = window.innerWidth >= 992 ? 'carousel' : 'scroll';

                    window.addEventListener("resize", () => {
                        const newMode = window.innerWidth >= 992 ? 'carousel' : 'scroll';
                        if (newMode !== currentCreatorMode) {
                            currentCreatorMode = newMode;
                            renderCreators(latestCreators);
                        }
                    });

                    function renderCreators(classList) {
                        const creatorMap = new Map();

                        classList.forEach(cls => {
                            if (cls.creatorName && !creatorMap.has(cls.creatorName)) {
                                creatorMap.set(cls.creatorName, {
                                    name: cls.creatorName,
                                    profileImage: cls.creatorProfileImg,
                                    description: cls.creatorDescription
                                });
                            }
                        });

                        const creators = Array.from(creatorMap.values());
                        latestCreators = creators;

                        const sectionId = `creator-carousel`;
                        const isWideScreen = window.innerWidth >= 992;

                        if (isWideScreen) {
                            const slides = [];
                            for (let i = 0; i < creators.length; i += 5) {
                                const group = creators.slice(i, i + 5);
                                while (group.length < 5) group.push(null); // 빈 칸 채우기
                                slides.push(group);
                            }

                            const slideItemsHtml = slides.map((group, idx) => `
        <div class="carousel-item ${idx === 0 ? 'active' : ''}">
            <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-5 g-3">
                ${group.map(creator => {
                                if (!creator) return `<div class="col"></div>`;
                                return `
                        <div class="col">
                            <div class="creator-card border rounded text-center p-3 h-100" style="background-color: white;">
                                <img src="${creator.profileImage}" alt="프로필"
                                     class="rounded-circle mb-2"
                                     style="width: 60px; height: 60px; object-fit: cover; border: 2px solid white;">
                                <p class="fw-bold small mb-1">${creator.name}</p>
                                <p class="text-muted small mb-0 text-truncate">${creator.description}</p>
                            </div>
                        </div>
                    `;
                            }).join('')}
            </div>
        </div>
    `).join('');

                            document.getElementById("creatorSectionContainer").innerHTML = `
        <section class="mb-5">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h5 class="fw-bold mb-0">크리에이터</h5>
                <div>
                    <button class="btn btn-sm me-2" type="button" data-bs-target="#${sectionId}" data-bs-slide="prev">
                        <i class="bi bi-chevron-left fs-5 text-dark"></i>
                    </button>
                    <button class="btn btn-sm" type="button" data-bs-target="#${sectionId}" data-bs-slide="next">
                        <i class="bi bi-chevron-right fs-5 text-dark"></i>
                    </button>
                </div>
            </div>
            <div id="${sectionId}" class="carousel slide" data-bs-ride="false">
                <div class="carousel-inner">
                    ${slideItemsHtml}
                </div>
            </div>
        </section>
    `;
                        }
                    }

                    const categoryIdx = /*[[${categoryIdx}]]*/ 0;
                    let pageSize = parseInt(document.getElementById("pageSizeOption").value);
                    let currentPage = 0;
                    let currentSort = 'recent';

                    // 클래스 목록 불러오기
                    function loadClasses(page) {
                        currentPage = page;

                        fetch(`/api/classes/category/${categoryIdx}?page=${page}&size=${pageSize}`) //&sort=${currentSort}
                            .then(res => res.json())
                            .then(data => {
                                renderClassList(data.content);
                                renderPagination(data.totalPages, data.number);
                                renderCreators(data.content);
                            })
                            .catch(err => console.error("클래스 목록 로드 실패", err));
                    }

                    document.getElementById("pageSizeOption").addEventListener("change", (e) => {
                        pageSize = parseInt(e.target.value);
                        loadClasses(0); // 첫 페이지로 이동
                    });

                    document.getElementById("sortOption").addEventListener("change", (e) => {
                        currentSort = e.target.value;
                        loadClasses(0); // 첫 페이지로 이동
                    });


                    // 클래스 목록 렌더링
                    function renderClassList(classList) {
                        const container = document.getElementById("classListContainer");
                        container.innerHTML = "";

                        if (!classList.length) {
                            container.innerHTML = "<p class='text-muted'>등록된 클래스가 없습니다.</p>";
                            return;
                        }

                        classList.forEach(cls => {
                            const col = document.createElement("div");
                            col.className = "col d-flex";

                            const card = document.createElement("div");
                            card.className = "card h-100 position-relative";
                            card.style.width = "100%";

                            const img = document.createElement("img");
                            img.src = cls.thumbnailUrl || "/images/default-image.png";
                            img.className = "card-img-top";
                            img.alt = "썸네일";
                            img.onerror = function () {
                                this.onerror = null;
                                this.src = "/images/default-image.png";
                            };

                            const bookmark = document.createElement("div");
                            bookmark.className = "card-bookmark" + (cls.liked ? " active" : "");
                            bookmark.innerHTML = `<i class="bi ${cls.liked ? "bi-bookmark-fill" : "bi-bookmark"}"></i>`;
                            bookmark.style.cursor = "pointer";
                            bookmark.addEventListener("click", () => toggleBookmark(bookmark, cls.classIdx));

                            const body = document.createElement("div");
                            body.className = "card-body";

                            const title = document.createElement("p");
                            title.className = "card-title";
                            title.textContent = cls.classTitle;

                            const subtitle = document.createElement("p");
                            subtitle.className = "card-subtitle";
                            subtitle.textContent = `${cls.categoryName} │ ${cls.creatorName || ""}`;

                            body.appendChild(title);
                            body.appendChild(subtitle);

                            card.appendChild(img);
                            card.appendChild(bookmark);
                            card.appendChild(body);
                            col.appendChild(card);
                            container.appendChild(col);
                        });
                    }

                    // 페이지네이션 렌더링
                    function renderPagination(totalPages, currentPage) {
                        const pagination = document.getElementById("pagination");
                        pagination.innerHTML = "";

                        const groupSize = 10;
                        const currentGroup = Math.floor(currentPage / groupSize);
                        const startPage = currentGroup * groupSize;
                        const endPage = Math.min(startPage + groupSize, totalPages);

                        // <<
                        if (currentPage > 0) appendPageItem("<<", 0);

                        // <
                        if (startPage > 0) appendPageItem("<", startPage - 1);

                        // 페이지 숫자
                        for (let i = startPage; i < endPage; i++) {
                            appendPageItem(i + 1, i, i === currentPage);
                        }

                        // >
                        if (endPage < totalPages) appendPageItem(">", endPage);

                        // >>
                        if (currentPage < totalPages - 1) appendPageItem(">>", totalPages - 1);

                        function appendPageItem(label, pageIndex, isActive = false) {
                            const li = document.createElement("li");
                            li.className = `page-item ${isActive ? "active" : ""}`;

                            const btn = document.createElement("button");
                            btn.className = "page-link";
                            btn.textContent = label;
                            btn.addEventListener("click", () => {
                                if (pageIndex !== currentPage) {
                                    loadClasses(pageIndex);
                                }
                            });

                            li.appendChild(btn);
                            pagination.appendChild(li);
                        }
                    }

                    // 초기 로딩
                    window.addEventListener("DOMContentLoaded", () => {
                        loadClasses(0);
                    });

                    // 찜 토글 기능
                    const toggleBookmark = async (bookmarkEl, classId) => {
                        try {
                            const res = await fetch(`/api/class-like/${classId}`, {
                                method: "POST",
                                credentials: "same-origin"
                            });

                            if (res.status === 401) {
                                alert("로그인이 필요합니다.");
                                return;
                            }

                            const result = await res.json();
                            const icon = bookmarkEl.querySelector("i");

                            if (result.liked) {
                                bookmarkEl.classList.add("active");
                                icon.classList.remove("bi-bookmark");
                                icon.classList.add("bi-bookmark-fill");
                            } else {
                                bookmarkEl.classList.remove("active");
                                icon.classList.remove("bi-bookmark-fill");
                                icon.classList.add("bi-bookmark");
                            }
                        } catch (err) {
                            console.error("찜 상태 변경 실패:", err);
                        }
                    };
                </script>

            </main>
        </div>
    </div>
    <!-- 하단 고정 CTA 바 -->
    <div class="position-fixed bottom-0 start-0 end-0 bg-white border-top py-3 px-4 d-flex justify-content-between align-items-center"
         style="z-index: 1050;">
        <div class="fw-bold">듣고 싶은 클래스를 다 들어보세요<br><a href="#" class="text-decoration-underline text-dark">구독 더 알아보기</a>
        </div>
        <button class="btn btn-warning fw-bold px-4 py-2"
                style="width: 300px; background-color: #FE5D01; color: white;">바로 시작하기
        </button>
    </div>
</div>
</body>
</html>
